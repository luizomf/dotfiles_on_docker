# Terminal & colors (works locally, in Docker, and over SSH)
set -g default-terminal "tmux-256color"
set -ga terminal-features ",tmux-256color:Tc,xterm-256color:Tc,xterm-ghostty:Tc"
set -g allow-passthrough on

# Enable activity alerts
set -g monitor-activity on
set -g visual-bell off
set -g visual-activity off
set -g visual-silence off

# Increase history (buffer size)
set-option -g history-limit 30000
# Set vim keys for almost everything.
set-option -g mode-keys vi

set -g mouse off # I dont use mouse
set -g renumber-windows on # Reorder window numbers

# Start windows e panes from 1
set -g base-index 1
set -g pane-base-index 1

# Add title to the terminal
set -g set-titles on
# WIP Below (I am trying to find a good balance here)
# It shows and emoji in the title when prefix is pressed.
set -g set-titles-string '#(ps ax -o comm= -p "#{client_pid}" 2>/dev/null | \
grep -q sshd && printf "[SSH] ")\
#S | #I:#W #D | #H | #T #{session_alerts}\
#{?client_prefix,üÖøÔ∏è,}'

setw -g allow-rename off
setw -g automatic-rename off

# Enable clipboard integration
set -g set-clipboard on
set -g allow-passthrough on
bind -T copy-mode-vi v send -X begin-selection

# macOS: pbcopy
if-shell 'uname -s | grep -q Darwin' {
  bind -T copy-mode-vi y     send -X copy-pipe-and-cancel "pbcopy"
  bind -T copy-mode-vi Enter send -X copy-pipe-and-cancel "pbcopy"
}

# Linux / Docker / SSH: OSC 52
if-shell 'uname -s | grep -q Linux' {
  bind -T copy-mode-vi y     send -X copy-pipe-and-cancel \
    "tmux save-buffer - | base64 | tr -d '\n' | printf '\033]52;c;%s\007' \"$(cat)\""
  bind -T copy-mode-vi Enter send -X copy-pipe-and-cancel \
    "tmux save-buffer - | base64 | tr -d '\n' | printf '\033]52;c;%s\007' \"$(cat)\""
}

# <prefix> Ctrl+l - list all windows using fzf
bind C-l run-shell '${HOME}/dotfiles/tmux/scripts/fzf.sh'

# Popup Keybinds
# <prefix> Ctrl+n (temp notes) - Opens /tmp/scrach.md in nvim
bind-key C-n display-popup -E -w 60% -h 60% "nvim /tmp/scratch.md"
# <prefix> Ctrl+p (Python REPL) - Opens Python REPL (quit closes)
bind-key C-p display-popup -E -w 60% -h 60% "python"
# <prefix> Ctrl+h (htop) - Opens htop (q closes)
bind-key C-h display-popup -E -w 80% -h 80% "htop"
# <prefix> Ctrl+t (terminal) - Opens a new terminal popup (exit closes)
bind-key C-t display-popup -E -w80% -h80% ""
# <prefix> Ctrl+x (just run) - just recipe run (ESC closes)
bind-key C-x display-popup -w80% -h80% "just run"

# Toggle popup
# https://gist.github.com/LintaoAmons/22f6184b26bd5b93d8fe9f9276f50f75
# Credits goes to the gist above. But I changed it a lot.
# This opens a floating popup and keeps it opened. You can toggle with
# <prefix> Ctrl+w. You can switch sessions, windows and panes. It will
# keep everything intact. You can close it by exiting (exit).
bind-key -r C-w run-shell '${HOME}/dotfiles/tmux/scripts/popup.sh float_popup \
term "${HOME}"'

# THEME
set -g status-left-style NONE
set -g status-right-style NONE

# Status right
set -g status-right-length 100
set -g status-right "#{?client_prefix,#[fg=black bg=green]ÓÇ≤#[fg=green bold \
bg=black] #S #D ,#[fg=black bg=green]ÓÇ≤#[fg=white dim bg=black] #S #D }"

# Messages
set -g message-style "fg=green,bg=black"
set -g message-command-style "fg=green,bg=black"

# Enable status bar
set -g status "on"
set -g status-justify "left"

# Normal window colors. They have the same bg as the status bar
setw -g window-status-style "NONE,fg=black,bg=green"
# Arrow pointing forward in normal windows. Here we have one arrow
# before and other after the text as in: ÓÇ∞ id:name flags ÓÇ∞
# Both arrows have the save bg and fg as the status bar.
setw -g window-status-format "#[fg=green,bg=green]ÓÇ∞#[default] #I:#W #F \
#[fg=green,bg=green]ÓÇ∞#[default]"
# The current window also have both arrows, except its bg is black
# and fg green.
setw -g window-status-current-format "#[fg=green,bg=black]ÓÇ∞#[fg=white,\
bg=black] #I:#W #F #[fg=black,bg=green]ÓÇ∞#[default]"

# Reset some style if it is configured
setw -g window-status-separator ""
setw -g window-status-activity-style ""

set -g mode-style "fg=green,bg=black"
set -g message-command-style "fg=green,bg=black"
set -g message-style "fg=green,bg=black"

# This is the status default color. These colors have to match the colors
# configured in lines above.
set -g status-style "fg=black,bg=green"

# Status left
set -g status-left-length 100
set -g status-left '#[fg=green,bg=black]#(ps ax -o comm= -p "#{client_pid}" 2>/dev/null | \
grep -q sshd && printf " [SSH]")\
#{?client_prefix, [#h] ‚úº ,#[fg=white dim bg=black] [#h] - \
#[default]}#[fg=black,bg=green]ÓÇ∞#[default]'

# TPM (Plugin Manager)
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible' # Configura√ß√µes sensatas padr√£o
set -g @plugin 'tmux-plugins/tmux-resurrect' # Salva e restaura sess√µes
set -g @plugin 'tmux-plugins/tmux-continuum' # Restaura√ß√£o autom√°tica

# Continuum config
set -g @continuum-restore 'on' # restore when I open tmux
# Save every 5 minutes
set -g @continuum-save-interval '5'

# Start TPM
run '${HOME}/.tmux/plugins/tpm/tpm'

